from pathlib import Path
path = Path('ml/backtest.py')
text = path.read_text(encoding='utf-8')
old = "def simulate_strategy(df: pd.DataFrame, model, feature_names: List[str]) -> Tuple[List[float], List[float], List[float]]:\n    cash = INITIAL_CAPITAL\n    shares = 0.0\n    equity_curve: List[float] = []\n    scores: List[float] = []\n\n    bh_shares = INITIAL_CAPITAL / float(df.iloc[0][\"close\"])\n    bh_curve: List[float] = []\n\n    initial_price = float(df.iloc[0][\"close\"])\n    if initial_price <= 0:\n        raise ValueError(\"Preço inicial inválido para Buy & Hold.\")\n    bh_shares = INITIAL_CAPITAL / initial_price\n\n    for _, row in df.iterrows():\n        price = float(row[\"close\"])\n        if price <= 0:\n            equity_curve.append(cash + shares * row[\"close\"])\n            bh_curve.append(bh_shares * row[\"close\"])\n            scores.append(scores[-1] if scores else 5.0)\n            continue\n        features = row.reindex(feature_names).astype(float).fillna(0.0).values.reshape(1, -1)\n        raw_pred = float(model.predict(features)[0])\n        risk_value = float(row.get(\"volatility_30\", 0.0))\n        score = prediction_to_score(raw_pred, risk_value)\n        scores.append(score)\n\n        if score > BUY_THRESHOLD and cash > 0:\n            shares = cash / price\n            cash = 0.0\n        elif score < SELL_THRESHOLD and shares > 0:\n            cash += shares * price\n            shares = 0.0\n\n        equity_curve.append(cash + shares * price)\n        bh_curve.append(bh_shares * price)\n\n    return equity_curve, bh_curve, scores\n\n\n\n"
new = "def simulate_strategy(\n    df: pd.DataFrame, model, feature_names: List[str]\n) -> Tuple[List[float], List[float], List[float], List[pd.Timestamp]]:\n    cash = INITIAL_CAPITAL\n    shares = 0.0\n    equity_curve: List[float] = []\n    scores: List[float] = []\n    dates: List[pd.Timestamp] = []\n\n    valid_prices = df[df[\"close\"] > 0]\n    if valid_prices.empty:\n        raise ValueError(\"Nenhum preço válido encontrado para o backtest.\")\n    bh_shares = INITIAL_CAPITAL / float(valid_prices.iloc[0][\"close\"])\n    bh_curve: List[float] = []\n\n    for _, row in df.iterrows():\n        price = float(row[\"close\"])\n        if price <= 0:\n            continue\n\n        dates.append(row[\"date\"])\n        features = row.reindex(feature_names).astype(float).fillna(0.0).values.reshape(1, -1)\n        raw_pred = float(model.predict(features)[0])\n        risk_value = float(row.get(\"volatility_30\", 0.0))\n        score = prediction_to_score(raw_pred, risk_value)\n        scores.append(score)\n\n        if score > BUY_THRESHOLD and cash > 0:\n            shares = cash / price\n            cash = 0.0\n        elif score < SELL_THRESHOLD and shares > 0:\n            cash += shares * price\n            shares = 0.0\n\n        equity_curve.append(cash + shares * price)\n        bh_curve.append(bh_shares * price)\n\n    return equity_curve, bh_curve, scores, dates\n\n\n\n"
if old not in text:
    raise SystemExit('old block not found')
path.write_text(text.replace(old, new, 1), encoding='utf-8')
